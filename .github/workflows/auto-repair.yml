name: Auto-Repair System

on:
  # IssueãŒä½œæˆã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  issues:
    types: [opened, labeled]

  # å®šæœŸçš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ10åˆ†ã”ã¨ï¼‰
  schedule:
    - cron: '*/10 * * * *'  # 10åˆ†ã”ã¨ã«å®Ÿè¡Œ

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to repair (optional)'
        required: false
        type: number

jobs:
  # å®šæœŸãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run health check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: development
        run: |
          python scripts/health_check.py || true

      - name: Upload health check logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-logs
          path: logs/health_checks/
          retention-days: 7

  # è‡ªå‹•ä¿®å¾©ã‚¸ãƒ§ãƒ–
  auto-repair:
    name: Auto-Repair Agent
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'auto-repair')) ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'auto-repair') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check for manual-repair label
        id: check_label
        run: |
          LABELS=$(gh issue view ${{ steps.issue.outputs.number }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "manual-repair"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Issue has manual-repair label. Skipping auto-repair."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run auto-repair agent (Single attempt)
        if: steps.check_label.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: development
        run: |
          # å˜ä¸€è©¦è¡Œã®ã¿å®Ÿè¡Œï¼ˆãƒ«ãƒ¼ãƒ—ã¯GitHub Actionsã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ç®¡ç†ï¼‰
          python scripts/auto_repair.py --issue ${{ steps.issue.outputs.number }} --max-retries 1 --retry-interval 0

      - name: Upload repair logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-repair-logs-issue-${{ steps.issue.outputs.number }}
          path: logs/
          retention-days: 7

      - name: Comment on success
        if: success()
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --body "âœ… è‡ªå‹•ä¿®å¾©ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on failure
        if: failure()
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} --body "âš ï¸ è‡ªå‹•ä¿®å¾©ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚æ¬¡å›ã®è‡ªå‹•å®Ÿè¡Œï¼ˆ10åˆ†å¾Œï¼‰ã§å†è©¦è¡Œã—ã¾ã™ã€‚é€£ç¶šã—ã¦å¤±æ•—ã™ã‚‹å ´åˆã¯ \`manual-repair\` ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¦æ‰‹å‹•å¯¾å¿œã—ã¦ãã ã•ã„ã€‚"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ä¿®å¾©è©¦è¡Œå›æ•°ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
  track-repair-attempts:
    name: Track Repair Attempts
    runs-on: ubuntu-latest
    needs: auto-repair
    if: always() && (github.event_name == 'issues' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Count repair attempts
        id: count
        run: |
          # Issueã®ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‹ã‚‰ä¿®å¾©è©¦è¡Œå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          ATTEMPT_COUNT=$(gh issue view ${{ steps.issue.outputs.number }} --json comments --jq '.comments | map(select(.body | contains("è‡ªå‹•ä¿®å¾©è©¦è¡Œ"))) | length')
          echo "attempts=$ATTEMPT_COUNT" >> $GITHUB_OUTPUT
          echo "Current repair attempts: $ATTEMPT_COUNT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add manual-repair label if max attempts reached
        if: steps.count.outputs.attempts >= 10
        run: |
          gh issue edit ${{ steps.issue.outputs.number }} --add-label "manual-repair"
          gh issue comment ${{ steps.issue.outputs.number }} --body "ğŸ”´ **æœ€å¤§è©¦è¡Œå›æ•°ï¼ˆ10å›ï¼‰ã«åˆ°é”ã—ã¾ã—ãŸ**

è‡ªå‹•ä¿®å¾©ãŒ10å›é€£ç¶šã§å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚

**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
2. æ ¹æœ¬åŸå› ã‚’èª¿æŸ»
3. æ‰‹å‹•ã§ä¿®å¾©ã‚’å®Ÿæ–½
4. ä¿®å¾©å®Œäº†å¾Œã€ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º

è‡ªå‹•ä¿®å¾©ã‚’å†é–‹ã™ã‚‹å ´åˆã¯ã€\`manual-repair\` ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
