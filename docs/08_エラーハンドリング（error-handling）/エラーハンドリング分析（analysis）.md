# PowerShell エラーハンドリング強化 - 分析・改善提案書

## 現状分析

### スクリプト統計
- **総行数**: 2,883行
- **関数数**: 44関数
- **Try-Catchブロック**: 52個実装済み
- **コメント率**: 0.2%（60行/2,883行）

### ファイル構成
1. `common_functions.ps1` (548行) - 共通機能・ログ・API通信
2. `veeam_integration.ps1` (392行) - Veeam連携
3. `wsb_integration.ps1` (426行) - Windows Server Backup連携
4. `aomei_integration.ps1` (569行) - AOMEI連携
5. `install.ps1` (474行) - インストール処理
6. `register_scheduled_tasks.ps1` (474行) - タスク登録

## 検出された改善点

### 1. エラーハンドリングの課題

#### 1.1 リトライロジック不足
**問題点:**
- API呼び出し失敗時、リトライ機構がない
- ネットワーク一時的エラーで即座に失敗
- 指数バックオフ未実装

**影響範囲:**
- `Send-BackupStatus()` - API送信失敗で即終了
- `Send-BackupCopyStatus()` - リトライなし
- `Send-BackupExecution()` - 一度失敗で終了

**推奨改善:**
```
リトライ回数: 3回
初期待機: 1秒
最大待機: 30秒
バックオフ方式: 指数関数（1秒 → 2秒 → 4秒）
```

#### 1.2 エラーログの詳細度不足
**問題点:**
- スタックトレース情報が不完全
- エラーの根本原因特定が困難
- API レスポンスボディ全体をログしていない場合がある

**影響範囲:**
- `Get-VeeamJobInfo()` - エラー発生時の詳細ログ不十分
- `Get-WSBJobInfo()` - バックアップサイズ取得失敗時のログ最小限

**推奨改善:**
```
記録すべき情報:
- 完全なスタックトレース
- 関数名・行番号
- エラーコード・カテゴリー
- 入力パラメータ（機密除外）
- タイムスタンプ（ISO 8601形式）
- エラーコンテキスト（実行中の操作）
```

#### 1.3 入力パラメータ検証不足
**問題点:**
- Null/空文字チェック最小限
- 型チェック不十分
- パラメータ範囲検証なし

**影響範囲:**
- `Send-BackupStatus()` - JobIdがゼロでも許可
- `Get-VeeamJobInfo()` - JobName空文字でも処理開始
- `Get-JobConfig()` - ジョブID型チェックなし

**推奨改善:**
```
実装項目:
- Null値チェック (test-null)
- 空文字チェック (test-empty)
- 型チェック (ValidateScript)
- 範囲チェック (JobId > 0)
- パターンマッチ (ジョブ名形式)
```

#### 1.4 エラー階層化なし
**問題点:**
- 全てのエラーを同じ方法で処理
- 回復可能/不可能エラーの区別なし
- エラー分類が曖昧

**影響範囲:**
- ネットワークエラー → 回復可能（リトライすべき）
- 認証エラー → 不可能（即座に終了）
- ファイルエラー → 部分的に回復可能

**推奨改善:**
```
エラー分類:
1. 一時的エラー (Transient)
   - ネットワークタイムアウト → リトライ5回
   - 一時的サービス利用不可 → リトライ3回

2. 永続的エラー (Permanent)
   - 認証失敗 → 即終了
   - ファイル見つからず → 即終了
   - パラメータ不正 → 即終了

3. 部分的エラー (Partial)
   - バックアップサイズ取得失敗 → 継続（デフォルト値使用）
```

### 2. ログ強化が必要な個所

#### 2.1 コメント不足（コメント率 0.2%）
**改善対象:**
- 複雑な処理の説明不足
- エラー処理の意図が不明確
- 関数の前提条件が不記載

#### 2.2 構造化ログが未実装
**改善対象:**
- JSON形式ログ出力なし
- ログレベルの使い分けが不十分
- エラー統計情報なし

#### 2.3 スタックトレース情報不足
**改善対象:**
- `$_.ScriptStackTrace` 利用が限定的
- エラーコンテキスト記録なし
- 呼び出し階層がわからない

### 3. 検出されたコード品質問題

#### 3.1 複数のネストされたTry-Catch
```powershell
# common_functions.ps1: Get-VeeamJobInfo()
try {
    try {
        $taskSessions = Get-VBRTaskSession -Session $session
        $backupSize = ($taskSessions | Measure-Object -Property TransferedSize -Sum).Sum
    }
    catch {
        Write-BackupLog -Level "WARNING" -Message "..."
    }
}
catch {
    # 外側のtry-catch
}
```
**改善:** ネストを削減し、エラー処理を統一

#### 3.2 マジックナンバーの使用
```powershell
# Get-WBJob -Previous 1  # 「1」の意味が不明確
# Convert-SecondsToHumanReadable で「3661秒」など
```
**改善:** 定数定義、説明的な変数名

#### 3.3 エラーメッセージが英日混在
```powershell
"ジョブが見つかりません: $JobName"  # 日本語
$_.Exception.Message  # 英語（PowerShell内部エラー）
```
**改善:** メッセージ形式統一

## 改善実装プラン

### Phase 1: リトライロジック実装（優先度: 高）
- Invoke-WithRetry ユーティリティ関数作成
- API呼び出し全てに適用
- 指数バックオフ実装

### Phase 2: エラーハンドリング強化（優先度: 高）
- エラー分類システム導入
- スタックトレース記録改善
- エラーコンテキスト追加

### Phase 3: ログ強化（優先度: 中）
- 構造化ログサポート
- コメント追加（コメント率30%以上目標）
- エラー統計レポート機能

### Phase 4: テスト実装（優先度: 中）
- エラーケーステスト
- リトライロジックテスト
- ログ出力テスト

## 期待効果

1. **信頼性向上**
   - API呼び出し成功率向上（リトライにより）
   - ネットワーク一時的障害に対応

2. **保守性向上**
   - エラー原因の迅速特定
   - デバッグ時間短縮

3. **可視性向上**
   - エラー発生パターンの把握
   - 運用改善の指標獲得

4. **品質向上**
   - コード理解度向上（コメント追加）
   - テストカバレッジ拡大
