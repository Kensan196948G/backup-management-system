{% extends "base.html" %}
{% block title %}レポート一覧 - バックアップ管理システム{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3"><i class="bi bi-file-earmark-bar-graph"></i> レポート管理</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">ホーム</a></li>
                            <li class="breadcrumb-item active">レポート一覧</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{{ url_for('reports.generate') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> 新規レポート生成
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Types -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-range fs-1 text-primary"></i>
                    <h5 class="mt-3">定期レポート</h5>
                    <p class="text-muted">日次・週次・月次の定期レポート</p>
                    <a href="{{ url_for('reports.generate') }}?type=periodic" class="btn btn-outline-primary">
                        生成
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-shield-check fs-1 text-success"></i>
                    <h5 class="mt-3">コンプライアンスレポート</h5>
                    <p class="text-muted">3-2-1ルール準拠状況</p>
                    <a href="{{ url_for('reports.generate') }}?type=compliance" class="btn btn-outline-success">
                        生成
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-bar-chart fs-1 text-info"></i>
                    <h5 class="mt-3">カスタムレポート</h5>
                    <p class="text-muted">期間・条件指定のカスタムレポート</p>
                    <a href="{{ url_for('reports.generate') }}?type=custom" class="btn btn-outline-info">
                        生成
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> フィルター</h5>
        </div>
        <div class="card-body">
            <form id="filter-form" class="row g-3">
                <div class="col-md-3">
                    <label for="filter-type" class="form-label">レポートタイプ</label>
                    <select class="form-select" id="filter-type">
                        <option value="">全て</option>
                        <option value="periodic">定期レポート</option>
                        <option value="compliance">コンプライアンス</option>
                        <option value="custom">カスタム</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-date-from" class="form-label">期間（開始）</label>
                    <input type="date" class="form-control" id="filter-date-from">
                </div>
                <div class="col-md-3">
                    <label for="filter-date-to" class="form-label">期間（終了）</label>
                    <input type="date" class="form-control" id="filter-date-to">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> 検索
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-table"></i> 生成済みレポート</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="reports-table" class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>レポートID</th>
                            <th>タイプ</th>
                            <th>対象期間</th>
                            <th>生成日時</th>
                            <th>生成者</th>
                            <th>ファイル形式</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td><strong>{{ report.id }}</strong></td>
                            <td>
                                {% if report.report_type == 'daily' or report.report_type == 'weekly' or report.report_type == 'monthly' %}
                                <span class="badge bg-primary">定期</span>
                                {% elif report.report_type == 'compliance' %}
                                <span class="badge bg-success">コンプライアンス</span>
                                {% elif report.report_type == 'audit' %}
                                <span class="badge bg-warning">監査</span>
                                {% else %}
                                <span class="badge bg-info">{{ report.report_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ report.date_from.strftime('%Y/%m/%d') }} - {{ report.date_to.strftime('%Y/%m/%d') }}</td>
                            <td>{{ report.created_at.strftime('%Y/%m/%d %H:%M') }}</td>
                            <td>{{ report.generator.username if report.generator else '不明' }}</td>
                            <td>
                                {% if report.file_format == 'pdf' %}
                                <i class="bi bi-file-earmark-pdf text-danger"></i> PDF
                                {% elif report.file_format == 'html' %}
                                <i class="bi bi-file-earmark-code text-primary"></i> HTML
                                {% elif report.file_format == 'csv' %}
                                <i class="bi bi-file-earmark-spreadsheet text-success"></i> CSV
                                {% else %}
                                <i class="bi bi-file-earmark text-secondary"></i> {{ report.file_format }}
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-success"
                                            onclick="showQuickView({{ report.id }})"
                                            data-bs-toggle="tooltip"
                                            title="クイック表示">
                                        <i class="bi bi-eye-fill"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary"
                                            onclick="showReportPreview({{ report.id }})"
                                            data-bs-toggle="tooltip"
                                            title="詳細プレビュー">
                                        <i class="bi bi-file-text"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-info"
                                            onclick="showShareModal({{ report.id }})"
                                            data-bs-toggle="tooltip"
                                            title="共有">
                                        <i class="bi bi-share"></i>
                                    </button>
                                    <a href="{{ url_for('reports.download', report_id=report.id) }}"
                                       class="btn btn-outline-secondary"
                                       data-bs-toggle="tooltip"
                                       title="ダウンロード">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% if current_user.role == 'admin' %}
                                    <button type="button" class="btn btn-outline-danger"
                                            onclick="showDeleteModal({{ report.id }})"
                                            data-bs-toggle="tooltip"
                                            title="削除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick View Modal -->
<div class="modal fade" id="quickViewModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="quickViewModalLabel">
                    <i class="bi bi-eye-fill"></i> クイック表示
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="quickViewContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" id="quickViewFullBtn">詳細を表示</button>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1" aria-labelledby="reportPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="reportPreviewModalLabel">
                    <i class="bi bi-file-text"></i> レポート詳細プレビュー
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="reportPreviewTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                                data-bs-target="#overview" type="button" role="tab">
                            <i class="bi bi-info-circle"></i> 概要
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="charts-tab" data-bs-toggle="tab"
                                data-bs-target="#charts" type="button" role="tab">
                            <i class="bi bi-graph-up"></i> グラフ
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="details-tab" data-bs-toggle="tab"
                                data-bs-target="#details" type="button" role="tab">
                            <i class="bi bi-list-ul"></i> 詳細
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab"
                                data-bs-target="#preview" type="button" role="tab">
                            <i class="bi bi-file-earmark"></i> プレビュー
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-4" id="reportPreviewTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div id="overviewContent">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Tab -->
                    <div class="tab-pane fade" id="charts" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">コンプライアンススコア</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="complianceChart" style="max-height: 300px;"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">バックアップ成功率</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="successRateChart" style="max-height: 300px;"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">バックアップトレンド</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="trendChart" style="max-height: 350px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Details Tab -->
                    <div class="tab-pane fade" id="details" role="tabpanel">
                        <div id="detailsContent">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Tab -->
                    <div class="tab-pane fade" id="preview" role="tabpanel">
                        <div id="previewContent" style="height: 600px; overflow-y: auto;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-success" id="downloadPdfBtn">
                        <i class="bi bi-file-pdf"></i> PDF
                    </button>
                    <button type="button" class="btn btn-info" id="downloadCsvBtn">
                        <i class="bi bi-file-spreadsheet"></i> CSV
                    </button>
                    <button type="button" class="btn btn-primary" id="downloadHtmlBtn">
                        <i class="bi bi-file-code"></i> HTML
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="bi bi-share"></i> レポート共有
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shareReportForm">
                    <input type="hidden" id="shareReportId" name="report_id">

                    <div class="mb-3">
                        <label for="shareEmail" class="form-label">
                            <i class="bi bi-envelope"></i> メールアドレス
                        </label>
                        <input type="email" class="form-control" id="shareEmail" name="email"
                               placeholder="example@company.com" required>
                        <div class="form-text">複数のアドレスはカンマで区切ってください</div>
                    </div>

                    <div class="mb-3">
                        <label for="shareSubject" class="form-label">
                            <i class="bi bi-text-left"></i> 件名
                        </label>
                        <input type="text" class="form-control" id="shareSubject" name="subject"
                               value="バックアップレポート" required>
                    </div>

                    <div class="mb-3">
                        <label for="shareMessage" class="form-label">
                            <i class="bi bi-chat-text"></i> メッセージ
                        </label>
                        <textarea class="form-control" id="shareMessage" name="message" rows="4"
                                  placeholder="オプションのメッセージを入力..."></textarea>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareIncludePdf" name="include_pdf" checked>
                            <label class="form-check-label" for="shareIncludePdf">
                                PDFファイルを添付
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> レポートは登録されたメールアドレスに送信されます。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-info" onclick="sendReportEmail()">
                    <i class="bi bi-send"></i> 送信
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-trash"></i> レポート削除確認
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>警告:</strong> この操作は取り消せません。
                </div>
                <p>レポートID <strong id="deleteReportId"></strong> を削除してもよろしいですか?</p>
                <p class="text-muted mb-0">
                    <small>レポートファイルとデータベースレコードが完全に削除されます。</small>
                </p>
                <input type="hidden" id="deleteReportIdValue">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteReport()">
                    <i class="bi bi-trash"></i> 削除
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
// Global variables for charts
let complianceChart = null;
let successRateChart = null;
let trendChart = null;
let currentReportId = null;

$(document).ready(function() {
    // Initialize DataTable
    $('#reports-table').DataTable({
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json' },
        order: [[3, 'desc']]
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Quick View Modal
function showQuickView(reportId) {
    currentReportId = reportId;
    const modal = new bootstrap.Modal(document.getElementById('quickViewModal'));

    // Reset content
    document.getElementById('quickViewContent').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">読み込み中...</span>
            </div>
        </div>
    `;

    modal.show();

    // Fetch report data
    fetch(`/api/reports/${reportId}`)
        .then(response => response.json())
        .then(data => {
            const report = data;
            const content = `
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-file-earmark-bar-graph text-primary"></i>
                            ${report.report_title || 'レポート'}
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong><i class="bi bi-tag"></i> レポートタイプ:</strong><br>
                                    <span class="badge bg-primary ms-4">${report.report_type}</span>
                                </p>
                                <p class="mb-2">
                                    <strong><i class="bi bi-calendar-range"></i> 対象期間:</strong><br>
                                    <span class="ms-4">${report.date_from} 〜 ${report.date_to}</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong><i class="bi bi-file-earmark"></i> ファイル形式:</strong><br>
                                    <span class="badge bg-info ms-4">${report.file_format.toUpperCase()}</span>
                                </p>
                                <p class="mb-2">
                                    <strong><i class="bi bi-clock"></i> 生成日時:</strong><br>
                                    <span class="ms-4">${new Date(report.created_at).toLocaleString('ja-JP')}</span>
                                </p>
                                <p class="mb-2">
                                    <strong><i class="bi bi-person"></i> 生成者:</strong><br>
                                    <span class="ms-4">${report.generator ? report.generator.full_name : '不明'}</span>
                                </p>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            <strong>クイックサマリー</strong><br>
                            このレポートには ${report.report_type} に関する詳細な情報が含まれています。
                            完全なプレビューを表示するには「詳細を表示」ボタンをクリックしてください。
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('quickViewContent').innerHTML = content;
        })
        .catch(error => {
            console.error('Error loading report:', error);
            document.getElementById('quickViewContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    レポートの読み込みに失敗しました。
                </div>
            `;
        });

    // Quick view full button handler
    document.getElementById('quickViewFullBtn').onclick = function() {
        modal.hide();
        showReportPreview(reportId);
    };
}

// Report Preview Modal with Tabs
function showReportPreview(reportId) {
    currentReportId = reportId;
    const modal = new bootstrap.Modal(document.getElementById('reportPreviewModal'));
    modal.show();

    // Load overview
    loadReportOverview(reportId);

    // Setup tab event listeners for lazy loading
    document.getElementById('charts-tab').addEventListener('shown.bs.tab', function() {
        loadReportCharts(reportId);
    }, { once: true });

    document.getElementById('details-tab').addEventListener('shown.bs.tab', function() {
        loadReportDetails(reportId);
    }, { once: true });

    document.getElementById('preview-tab').addEventListener('shown.bs.tab', function() {
        loadReportPreview(reportId);
    }, { once: true });

    // Setup download buttons
    setupDownloadButtons(reportId);
}

function loadReportOverview(reportId) {
    fetch(`/api/reports/${reportId}`)
        .then(response => response.json())
        .then(data => {
            const report = data;
            const content = `
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-primary text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-file-earmark-bar-graph fs-1"></i>
                                <h5 class="mt-3">レポートタイプ</h5>
                                <p class="fs-4 mb-0">${report.report_type}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-success text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-calendar-check fs-1"></i>
                                <h5 class="mt-3">対象期間</h5>
                                <p class="mb-0">${report.date_from}</p>
                                <p class="mb-0">〜</p>
                                <p class="mb-0">${report.date_to}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-info text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-file-earmark fs-1"></i>
                                <h5 class="mt-3">ファイル形式</h5>
                                <p class="fs-4 mb-0">${report.file_format.toUpperCase()}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> レポート詳細情報</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <th width="30%">レポートID:</th>
                                <td>${report.id}</td>
                            </tr>
                            <tr>
                                <th>タイトル:</th>
                                <td>${report.report_title || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>生成者:</th>
                                <td>${report.generator ? report.generator.full_name + ' (' + report.generator.username + ')' : '不明'}</td>
                            </tr>
                            <tr>
                                <th>生成日時:</th>
                                <td>${new Date(report.created_at).toLocaleString('ja-JP')}</td>
                            </tr>
                            <tr>
                                <th>ファイルステータス:</th>
                                <td>
                                    ${report.has_file
                                        ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> 利用可能</span>'
                                        : '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> ファイルなし</span>'}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-clipboard-data"></i> エグゼクティブサマリー</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-graph-up-arrow"></i> 主要メトリクス</h6>
                            <ul class="mb-0">
                                <li>レポートタイプ: <strong>${report.report_type}</strong></li>
                                <li>期間: <strong>${calculateDaysDifference(report.date_from, report.date_to)} 日間</strong></li>
                                <li>データ形式: <strong>${report.file_format.toUpperCase()}</strong></li>
                            </ul>
                        </div>
                        <p class="mb-0 text-muted">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                詳細な統計情報とグラフは「グラフ」タブでご確認ください。
                            </small>
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('overviewContent').innerHTML = content;
        })
        .catch(error => {
            console.error('Error loading overview:', error);
            document.getElementById('overviewContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    データの読み込みに失敗しました。
                </div>
            `;
        });
}

function loadReportCharts(reportId) {
    // Generate sample data for demonstration
    // In production, this should fetch real data from the API

    // Compliance Chart (Doughnut)
    const complianceCtx = document.getElementById('complianceChart').getContext('2d');
    if (complianceChart) complianceChart.destroy();
    complianceChart = new Chart(complianceCtx, {
        type: 'doughnut',
        data: {
            labels: ['準拠', '警告', '非準拠'],
            datasets: [{
                data: [75, 15, 10],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: '3-2-1-1-0ルール準拠状況'
                }
            }
        }
    });

    // Success Rate Chart (Bar)
    const successCtx = document.getElementById('successRateChart').getContext('2d');
    if (successRateChart) successRateChart.destroy();
    successRateChart = new Chart(successCtx, {
        type: 'bar',
        data: {
            labels: ['成功', '警告', '失敗', 'スキップ'],
            datasets: [{
                label: 'バックアップジョブ',
                data: [85, 8, 5, 2],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(108, 117, 125, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)',
                    'rgba(108, 117, 125, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'バックアップ実行結果'
                }
            }
        }
    });

    // Trend Chart (Line)
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
            datasets: [{
                label: '成功',
                data: [92, 88, 95, 90, 94, 96],
                borderColor: 'rgba(40, 167, 69, 1)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: '失敗',
                data: [5, 8, 3, 6, 4, 2],
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: '警告',
                data: [3, 4, 2, 4, 2, 2],
                borderColor: 'rgba(255, 193, 7, 1)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: '週別バックアップ成功率トレンド'
                }
            }
        }
    });
}

function loadReportDetails(reportId) {
    const content = `
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> 詳細な調査結果</h6>
            </div>
            <div class="card-body">
                <div class="accordion" id="findingsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#finding1">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <strong>準拠項目 (15件)</strong>
                            </button>
                        </h2>
                        <div id="finding1" class="accordion-collapse collapse show" data-bs-parent="#findingsAccordion">
                            <div class="accordion-body">
                                <ul class="list-group">
                                    <li class="list-group-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        3-2-1ルール: 3コピー確保済み
                                    </li>
                                    <li class="list-group-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        2種類のメディアに保存済み
                                    </li>
                                    <li class="list-group-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        1コピーがオフサイトに保存済み
                                    </li>
                                    <li class="list-group-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        イミュータブルバックアップ設定済み
                                    </li>
                                    <li class="list-group-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        検証テスト: 全て成功
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#finding2">
                                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                <strong>警告項目 (3件)</strong>
                            </button>
                        </h2>
                        <div id="finding2" class="accordion-collapse collapse" data-bs-parent="#findingsAccordion">
                            <div class="accordion-body">
                                <ul class="list-group">
                                    <li class="list-group-item list-group-item-warning">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        ストレージ使用率が80%を超えています
                                    </li>
                                    <li class="list-group-item list-group-item-warning">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        一部のバックアップジョブで遅延が発生
                                    </li>
                                    <li class="list-group-item list-group-item-warning">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        オフラインメディアの検証が30日以上未実施
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#finding3">
                                <i class="bi bi-x-circle text-danger me-2"></i>
                                <strong>要対応項目 (1件)</strong>
                            </button>
                        </h2>
                        <div id="finding3" class="accordion-collapse collapse" data-bs-parent="#findingsAccordion">
                            <div class="accordion-body">
                                <ul class="list-group">
                                    <li class="list-group-item list-group-item-danger">
                                        <i class="bi bi-x-circle-fill"></i>
                                        1つのバックアップジョブが48時間以上失敗中
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4 mb-0">
                    <h6><i class="bi bi-lightbulb"></i> 推奨アクション</h6>
                    <ol class="mb-0">
                        <li>ストレージ容量の拡張または古いバックアップの削除を検討してください</li>
                        <li>失敗しているバックアップジョブの設定を確認してください</li>
                        <li>オフラインメディアの定期的な検証スケジュールを設定してください</li>
                    </ol>
                </div>
            </div>
        </div>
    `;
    document.getElementById('detailsContent').innerHTML = content;
}

function loadReportPreview(reportId) {
    fetch(`/api/reports/${reportId}`)
        .then(response => response.json())
        .then(data => {
            const report = data;
            if (report.file_format === 'html' && report.has_file) {
                // For HTML reports, load via iframe
                const content = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        HTMLレポートのプレビューを表示しています。完全版をダウンロードするには下部のダウンロードボタンをご利用ください。
                    </div>
                    <iframe src="/reports/${reportId}/download"
                            style="width: 100%; height: 550px; border: 1px solid #ddd; border-radius: 4px;">
                    </iframe>
                `;
                document.getElementById('previewContent').innerHTML = content;
            } else if (report.file_format === 'pdf' && report.has_file) {
                // For PDF, show embed
                const content = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        PDFレポートのプレビューです。ブラウザによっては表示されない場合があります。
                    </div>
                    <embed src="/reports/${reportId}/download"
                           type="application/pdf"
                           style="width: 100%; height: 550px; border: 1px solid #ddd; border-radius: 4px;">
                `;
                document.getElementById('previewContent').innerHTML = content;
            } else {
                const content = `
                    <div class="alert alert-warning text-center py-5">
                        <i class="bi bi-file-earmark fs-1"></i>
                        <h5 class="mt-3">プレビューは利用できません</h5>
                        <p class="mb-0">このファイル形式(${report.file_format.toUpperCase()})のプレビューはサポートされていません。<br>
                        ダウンロードボタンからファイルをダウンロードしてください。</p>
                    </div>
                `;
                document.getElementById('previewContent').innerHTML = content;
            }
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            document.getElementById('previewContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    プレビューの読み込みに失敗しました。
                </div>
            `;
        });
}

function setupDownloadButtons(reportId) {
    document.getElementById('downloadPdfBtn').onclick = function() {
        window.location.href = `/reports/${reportId}/download`;
    };
    document.getElementById('downloadCsvBtn').onclick = function() {
        window.location.href = `/reports/${reportId}/download`;
    };
    document.getElementById('downloadHtmlBtn').onclick = function() {
        window.location.href = `/reports/${reportId}/download`;
    };
}

// Share Modal
function showShareModal(reportId) {
    currentReportId = reportId;
    document.getElementById('shareReportId').value = reportId;
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    modal.show();
}

function sendReportEmail() {
    const reportId = document.getElementById('shareReportId').value;
    const email = document.getElementById('shareEmail').value;
    const subject = document.getElementById('shareSubject').value;
    const message = document.getElementById('shareMessage').value;
    const includePdf = document.getElementById('shareIncludePdf').checked;

    if (!email || !subject) {
        alert('メールアドレスと件名は必須です。');
        return;
    }

    // In production, this would call an API endpoint
    // For now, show a success message
    const formData = {
        report_id: reportId,
        email: email,
        subject: subject,
        message: message,
        include_pdf: includePdf
    };

    console.log('Sending email with data:', formData);

    // Simulate API call
    setTimeout(() => {
        alert('レポートをメールで送信しました。');
        bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
        document.getElementById('shareReportForm').reset();
    }, 500);
}

// Delete Modal
function showDeleteModal(reportId) {
    currentReportId = reportId;
    document.getElementById('deleteReportId').textContent = reportId;
    document.getElementById('deleteReportIdValue').value = reportId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function confirmDeleteReport() {
    const reportId = document.getElementById('deleteReportIdValue').value;

    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/reports/${reportId}/delete`;

    // Add CSRF token if available
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrf_token';
        input.value = csrfToken.content;
        form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
}

// Helper function
function calculateDaysDifference(dateFrom, dateTo) {
    const date1 = new Date(dateFrom);
    const date2 = new Date(dateTo);
    const diffTime = Math.abs(date2 - date1);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}
</script>
{% endblock %}
