{% extends "base.html" %}
{% block title %}システム設定 - バックアップ管理システム{% endblock %}

{% block extra_css %}
<style>
    .settings-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .nav-pills .nav-link {
        color: #495057;
        border-radius: 8px;
        padding: 0.75rem 1.25rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .nav-pills .nav-link:hover {
        background-color: #f8f9fa;
        color: #0d6efd;
    }

    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .nav-pills .nav-link i {
        width: 20px;
        margin-right: 8px;
    }

    .settings-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-radius: 10px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .settings-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
        padding: 1rem 1.5rem;
        font-weight: 600;
    }

    .settings-card .card-body {
        padding: 1.5rem;
    }

    .setting-item {
        padding: 1rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .setting-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }

    .setting-description {
        font-size: 0.875rem;
        color: #718096;
        margin-bottom: 0.75rem;
    }

    .info-box {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        border-left: 4px solid #0ea5e9;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }

    .warning-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }

    .danger-box {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left: 4px solid #ef4444;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }

    .system-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .info-stat {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .info-stat:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }

    .info-stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 0.25rem;
    }

    .info-stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-save {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .tab-content {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .badge-version {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 0.5rem 1rem;
        font-size: 1rem;
    }

    /* User Management Styles */
    .badge-role {
        padding: 0.35rem 0.65rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 6px;
    }

    .badge-role.role-admin {
        background-color: #dc3545;
        color: white;
    }

    .badge-role.role-operator {
        background-color: #0d6efd;
        color: white;
    }

    .badge-role.role-viewer {
        background-color: #198754;
        color: white;
    }

    .badge-role.role-auditor {
        background-color: #ffc107;
        color: #000;
    }

    .status-active {
        color: #198754;
        font-weight: 600;
    }

    .status-inactive {
        color: #dc3545;
        font-weight: 600;
    }

    .password-strength-meter {
        height: 5px;
        background-color: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .password-strength-bar {
        height: 100%;
        transition: all 0.3s ease;
    }

    .password-strength-weak {
        background-color: #dc3545;
        width: 33%;
    }

    .password-strength-medium {
        background-color: #ffc107;
        width: 66%;
    }

    .password-strength-strong {
        background-color: #198754;
        width: 100%;
    }

    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        margin: 0 0.125rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    table.dataTable tbody tr:hover {
        background-color: #f8f9fa;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }

    .invalid-feedback {
        display: none;
    }

    .is-invalid ~ .invalid-feedback {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="settings-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-2"><i class="bi bi-gear"></i> システム設定</h1>
                <p class="mb-0 opacity-75">バックアップ管理システムの各種設定を管理</p>
            </div>
            <div>
                <span class="badge badge-version">v3.2.1.1.0</span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card settings-card">
                <div class="card-body">
                    <div class="nav flex-column nav-pills" id="settings-tabs" role="tablist">
                        <a class="nav-link active" id="backup-tab" data-bs-toggle="pill" href="#backup" role="tab">
                            <i class="bi bi-hdd-stack"></i> バックアップ設定
                        </a>
                        <a class="nav-link" id="notification-tab" data-bs-toggle="pill" href="#notification" role="tab">
                            <i class="bi bi-bell"></i> 通知設定
                        </a>
                        <a class="nav-link" id="schedule-tab" data-bs-toggle="pill" href="#schedule" role="tab">
                            <i class="bi bi-clock-history"></i> スケジュール設定
                        </a>
                        <a class="nav-link" id="storage-tab" data-bs-toggle="pill" href="#storage" role="tab">
                            <i class="bi bi-database"></i> ストレージ設定
                        </a>
                        <a class="nav-link" id="security-tab" data-bs-toggle="pill" href="#security" role="tab">
                            <i class="bi bi-shield-lock"></i> セキュリティ設定
                        </a>
                        <a class="nav-link" id="system-tab" data-bs-toggle="pill" href="#system" role="tab">
                            <i class="bi bi-info-circle"></i> システム情報
                        </a>
                        <a class="nav-link" id="users-tab" data-bs-toggle="pill" href="#users" role="tab">
                            <i class="bi bi-people"></i> ユーザー管理
                        </a>
                        <a class="nav-link" id="import-export-tab" data-bs-toggle="pill" href="#import-export" role="tab">
                            <i class="bi bi-arrow-down-up"></i> インポート・エクスポート
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="bi bi-lightning"></i> クイックアクション
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportSettings()">
                            <i class="bi bi-download"></i> 設定をエクスポート
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="importSettings()">
                            <i class="bi bi-upload"></i> 設定をインポート
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="resetToDefaults()">
                            <i class="bi bi-arrow-counterclockwise"></i> デフォルトに戻す
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <form method="POST" action="{{ url_for('settings.update') }}" id="settings-form">
                <div class="tab-content" id="settings-tabContent">
                    <!-- Backup Settings -->
                    <div class="tab-pane fade show active" id="backup" role="tabpanel">
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-hdd-stack"></i> バックアップ設定
                            </div>
                            <div class="card-body">
                                <div class="info-box">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>情報:</strong> これらの設定は新規バックアップジョブのデフォルト値として使用されます。
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="default_retention">デフォルト保持期間</label>
                                    <div class="setting-description">バックアップファイルを保持する日数</div>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="number" class="form-control" id="default_retention" name="default_retention" value="90" min="1">
                                        <span class="input-group-text">日</span>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="compression_level">圧縮レベル</label>
                                    <div class="setting-description">バックアップファイルの圧縮率（高いほど時間がかかります）</div>
                                    <div style="max-width: 400px;">
                                        <select class="form-select" id="compression_level" name="compression_level">
                                            <option value="0">なし (最速)</option>
                                            <option value="1">低</option>
                                            <option value="5" selected>中 (推奨)</option>
                                            <option value="9">高 (最小サイズ)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">暗号化設定</label>
                                    <div class="setting-description">バックアップファイルの暗号化を有効にします</div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_encryption" name="enable_encryption" checked>
                                        <label class="form-check-label" for="enable_encryption">
                                            暗号化を有効にする (AES-256)
                                        </label>
                                    </div>
                                    <div id="encryption-options">
                                        <label class="form-label" for="encryption_key">暗号化キー</label>
                                        <div class="input-group mb-2" style="max-width: 500px;">
                                            <input type="password" class="form-control" id="encryption_key" name="encryption_key" placeholder="既存のキーは変更されません">
                                            <button class="btn btn-outline-secondary" type="button" onclick="generateKey()">
                                                <i class="bi bi-key"></i> 生成
                                            </button>
                                        </div>
                                        <small class="text-muted">キーを変更すると既存のバックアップが復元できなくなる可能性があります</small>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="max_parallel_jobs">最大並列実行数</label>
                                    <div class="setting-description">同時に実行できるバックアップジョブの最大数</div>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="number" class="form-control" id="max_parallel_jobs" name="max_parallel_jobs" value="3" min="1" max="10">
                                        <span class="input-group-text">ジョブ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="tab-pane fade" id="notification" role="tabpanel">
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-envelope"></i> メール通知設定
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_email" name="enable_email" checked>
                                        <label class="form-check-label fw-bold" for="enable_email">
                                            メール通知を有効にする
                                        </label>
                                    </div>
                                </div>

                                <div id="email-settings">
                                    <div class="setting-item">
                                        <label class="setting-label" for="smtp_server">SMTPサーバー</label>
                                        <input type="text" class="form-control" id="smtp_server" name="smtp_server" value="smtp.example.com" placeholder="smtp.example.com">
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="setting-item">
                                                <label class="setting-label" for="smtp_port">SMTPポート</label>
                                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="587">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="setting-item">
                                                <label class="setting-label" for="smtp_security">セキュリティ</label>
                                                <select class="form-select" id="smtp_security" name="smtp_security">
                                                    <option value="none">なし</option>
                                                    <option value="tls" selected>TLS</option>
                                                    <option value="ssl">SSL</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <label class="setting-label" for="smtp_username">ユーザー名</label>
                                        <input type="text" class="form-control" id="smtp_username" name="smtp_username" value="noreply@example.com">
                                    </div>

                                    <div class="setting-item">
                                        <label class="setting-label" for="smtp_password">パスワード</label>
                                        <input type="password" class="form-control" id="smtp_password" name="smtp_password" placeholder="既存のパスワードは変更されません">
                                    </div>

                                    <div class="setting-item">
                                        <label class="setting-label" for="notification_recipients">デフォルト送信先</label>
                                        <input type="text" class="form-control" id="notification_recipients" name="notification_recipients" value="admin@example.com" placeholder="複数の場合はカンマ区切り">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-slack"></i> Slack通知設定
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_slack" name="enable_slack">
                                        <label class="form-check-label fw-bold" for="enable_slack">
                                            Slack通知を有効にする
                                        </label>
                                    </div>
                                </div>

                                <div id="slack-settings">
                                    <div class="setting-item">
                                        <label class="setting-label" for="slack_webhook">Webhook URL</label>
                                        <input type="url" class="form-control" id="slack_webhook" name="slack_webhook" placeholder="https://hooks.slack.com/services/...">
                                    </div>

                                    <div class="setting-item">
                                        <label class="setting-label" for="slack_channel">チャンネル</label>
                                        <input type="text" class="form-control" id="slack_channel" name="slack_channel" placeholder="#backup-alerts">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-microsoft-teams"></i> Microsoft Teams通知設定
                            </div>
                            <div class="card-body">
                                <div class="setting-item">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_teams" name="enable_teams">
                                        <label class="form-check-label fw-bold" for="enable_teams">
                                            Teams通知を有効にする
                                        </label>
                                    </div>
                                </div>

                                <div id="teams-settings">
                                    <div class="setting-item">
                                        <label class="setting-label" for="teams_webhook">Webhook URL</label>
                                        <input type="url" class="form-control" id="teams_webhook" name="teams_webhook" placeholder="https://outlook.office.com/webhook/...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Settings -->
                    <div class="tab-pane fade" id="schedule" role="tabpanel">
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-clock-history"></i> デフォルトスケジュール設定
                            </div>
                            <div class="card-body">
                                <div class="info-box">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>情報:</strong> 新規ジョブ作成時のデフォルトスケジュール設定です。
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="default_schedule_type">デフォルトスケジュールタイプ</label>
                                    <select class="form-select" id="default_schedule_type" name="default_schedule_type" style="max-width: 400px;">
                                        <option value="daily">毎日</option>
                                        <option value="weekly" selected>毎週</option>
                                        <option value="monthly">毎月</option>
                                        <option value="custom">カスタム</option>
                                    </select>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="default_schedule_time">デフォルト実行時刻</label>
                                    <input type="time" class="form-control" id="default_schedule_time" name="default_schedule_time" value="02:00" style="max-width: 200px;">
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">メンテナンスウィンドウ</label>
                                    <div class="setting-description">この時間帯は新規バックアップを開始しません</div>
                                    <div class="row" style="max-width: 500px;">
                                        <div class="col-6">
                                            <label class="form-label small">開始時刻</label>
                                            <input type="time" class="form-control" id="maintenance_start" name="maintenance_start" value="08:00">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">終了時刻</label>
                                            <input type="time" class="form-control" id="maintenance_end" name="maintenance_end" value="18:00">
                                        </div>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="skip_holidays" name="skip_holidays">
                                        <label class="form-check-label" for="skip_holidays">
                                            祝日はスキップする
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Storage Settings -->
                    <div class="tab-pane fade" id="storage" role="tabpanel">
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-database"></i> ストレージ設定
                            </div>
                            <div class="card-body">
                                <div class="warning-box">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>警告:</strong> ストレージパスを変更すると、既存のバックアップにアクセスできなくなる可能性があります。
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="default_storage_path">デフォルトストレージパス</label>
                                    <div class="setting-description">バックアップファイルの保存先ディレクトリ</div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="default_storage_path" name="default_storage_path" value="/var/backups">
                                        <button class="btn btn-outline-secondary" type="button" onclick="browseFolder()">
                                            <i class="bi bi-folder"></i> 参照
                                        </button>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="storage_threshold">ストレージ容量閾値</label>
                                    <div class="setting-description">この使用率を超えるとアラートを発生します</div>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="number" class="form-control" id="storage_threshold" name="storage_threshold" value="80" min="50" max="95">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="auto_cleanup_threshold">自動クリーンアップ閾値</label>
                                    <div class="setting-description">この使用率を超えると古いバックアップを自動削除します</div>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="number" class="form-control" id="auto_cleanup_threshold" name="auto_cleanup_threshold" value="90" min="80" max="99">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enable_deduplication" name="enable_deduplication" checked>
                                        <label class="form-check-label" for="enable_deduplication">
                                            重複排除を有効にする
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        同一ファイルのハッシュを比較してストレージ容量を節約します
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-shield-lock"></i> セキュリティ設定
                            </div>
                            <div class="card-body">
                                <div class="danger-box">
                                    <i class="bi bi-shield-exclamation"></i>
                                    <strong>重要:</strong> セキュリティ設定を変更すると、ユーザーのアクセスに影響を与える可能性があります。
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="session_timeout">セッションタイムアウト</label>
                                    <div class="setting-description">ユーザーが自動的にログアウトされるまでの時間</div>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="number" class="form-control" id="session_timeout" name="session_timeout" value="30" min="5" max="1440">
                                        <span class="input-group-text">分</span>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">パスワードポリシー</label>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="require_uppercase" name="require_uppercase" checked>
                                        <label class="form-check-label" for="require_uppercase">
                                            大文字を必須とする
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="require_lowercase" name="require_lowercase" checked>
                                        <label class="form-check-label" for="require_lowercase">
                                            小文字を必須とする
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="require_numbers" name="require_numbers" checked>
                                        <label class="form-check-label" for="require_numbers">
                                            数字を必須とする
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="require_special" name="require_special" checked>
                                        <label class="form-check-label" for="require_special">
                                            特殊文字を必須とする
                                        </label>
                                    </div>
                                    <div class="row" style="max-width: 400px;">
                                        <div class="col-12">
                                            <label class="form-label small">最小文字数</label>
                                            <input type="number" class="form-control" id="min_password_length" name="min_password_length" value="8" min="6" max="32">
                                        </div>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="max_login_attempts">最大ログイン試行回数</label>
                                    <div class="setting-description">アカウントロックまでの失敗回数</div>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="number" class="form-control" id="max_login_attempts" name="max_login_attempts" value="5" min="3" max="10">
                                        <span class="input-group-text">回</span>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="lockout_duration">ロックアウト期間</label>
                                    <div class="setting-description">ログイン失敗後のロック時間</div>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="number" class="form-control" id="lockout_duration" name="lockout_duration" value="30" min="5" max="120">
                                        <span class="input-group-text">分</span>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enable_2fa" name="enable_2fa">
                                        <label class="form-check-label" for="enable_2fa">
                                            二要素認証を有効にする
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        全ユーザーに二要素認証の設定を要求します
                                    </small>
                                </div>

                                <div class="setting-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enable_audit_log" name="enable_audit_log" checked>
                                        <label class="form-check-label" for="enable_audit_log">
                                            監査ログを有効にする
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Info -->
                    <div class="tab-pane fade" id="system" role="tabpanel">
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-info-circle"></i> システム情報
                            </div>
                            <div class="card-body">
                                <div class="system-info-grid mb-4">
                                    <div class="info-stat">
                                        <div class="info-stat-value">v3.2.1.1.0</div>
                                        <div class="info-stat-label">バージョン</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value">PostgreSQL 14.5</div>
                                        <div class="info-stat-label">データベース</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value">512 MB</div>
                                        <div class="info-stat-label">DB容量</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value">2.4 GB</div>
                                        <div class="info-stat-label">ログ容量</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value">99.8%</div>
                                        <div class="info-stat-label">稼働率</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value">42日</div>
                                        <div class="info-stat-label">起動時間</div>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">システムパス</label>
                                    <table class="table table-sm">
                                        <tr>
                                            <td class="text-muted" style="width: 200px;">アプリケーションルート</td>
                                            <td><code>/opt/backup-management-system</code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">ログディレクトリ</td>
                                            <td><code>/var/log/backup-system</code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">設定ファイル</td>
                                            <td><code>/etc/backup-system/config.yaml</code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">データベース</td>
                                            <td><code>postgresql://localhost/backup_management</code></td>
                                        </tr>
                                    </table>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">依存パッケージ</label>
                                    <table class="table table-sm">
                                        <tr>
                                            <td class="text-muted" style="width: 200px;">Python</td>
                                            <td>3.10.12</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Flask</td>
                                            <td>3.0.0</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">SQLAlchemy</td>
                                            <td>2.0.23</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">WeasyPrint</td>
                                            <td>60.1</td>
                                        </tr>
                                    </table>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">システムヘルス</label>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 75%;">
                                            CPU: 75%
                                        </div>
                                    </div>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 82%;">
                                            メモリ: 82%
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 45%;">
                                            ディスク: 45%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-tools"></i> メンテナンス操作
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-primary" onclick="optimizeDatabase()">
                                        <i class="bi bi-gear"></i> データベースを最適化
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearCache()">
                                        <i class="bi bi-trash"></i> キャッシュをクリア
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="rotateLogs()">
                                        <i class="bi bi-arrow-repeat"></i> ログローテーション
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" onclick="testConnections()">
                                        <i class="bi bi-plug"></i> 接続テスト
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="tab-pane fade" id="users" role="tabpanel">
                        <div class="settings-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-people"></i> ユーザー管理
                                </div>
                                <button type="button" class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                                    <i class="bi bi-person-plus"></i> 新規ユーザー追加
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="info-box mb-3">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>情報:</strong> システムユーザーの追加、編集、削除を行います。ユーザーの権限によってアクセス可能な機能が制限されます。
                                </div>

                                <!-- Users DataTable -->
                                <div class="table-responsive">
                                    <table id="usersTable" class="table table-hover" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>ユーザー名</th>
                                                <th>メール</th>
                                                <th>氏名</th>
                                                <th>部署</th>
                                                <th>権限</th>
                                                <th>ステータス</th>
                                                <th>最終ログイン</th>
                                                <th>アクション</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be loaded via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- User Statistics -->
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-graph-up"></i> ユーザー統計
                            </div>
                            <div class="card-body">
                                <div class="system-info-grid">
                                    <div class="info-stat">
                                        <div class="info-stat-value" id="totalUsers">0</div>
                                        <div class="info-stat-label">総ユーザー数</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value" id="activeUsers">0</div>
                                        <div class="info-stat-label">アクティブ</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value" id="adminUsers">0</div>
                                        <div class="info-stat-label">管理者</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value" id="operatorUsers">0</div>
                                        <div class="info-stat-label">オペレーター</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value" id="lockedUsers">0</div>
                                        <div class="info-stat-label">ロック中</div>
                                    </div>
                                    <div class="info-stat">
                                        <div class="info-stat-value" id="onlineUsers">0</div>
                                        <div class="info-stat-label">オンライン</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Import/Export Settings -->
                    <div class="tab-pane fade" id="import-export" role="tabpanel">
                        <!-- Export Settings -->
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-download"></i> エクスポート設定
                            </div>
                            <div class="card-body">
                                <div class="info-box mb-3">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>エクスポート機能について:</strong> システムの設定をファイルとして保存できます。バックアップや他のシステムへの設定移行に便利です。
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">エクスポート形式</label>
                                    <div class="setting-description">設定をエクスポートするファイル形式を選択してください</div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="export_format" id="export_json" value="json" checked>
                                        <label class="form-check-label" for="export_json">
                                            <strong>JSON形式</strong> - 構造化データ、システム間移行に最適
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="export_format" id="export_csv" value="csv">
                                        <label class="form-check-label" for="export_csv">
                                            <strong>CSV形式</strong> - 表形式データ、Excel等で編集可能
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">エクスポート対象</label>
                                    <div class="setting-description">エクスポートする設定項目を選択してください</div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="export_backup" name="export_backup" checked>
                                                <label class="form-check-label" for="export_backup">
                                                    バックアップ設定
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="export_notification" name="export_notification" checked>
                                                <label class="form-check-label" for="export_notification">
                                                    通知設定
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="export_schedule" name="export_schedule" checked>
                                                <label class="form-check-label" for="export_schedule">
                                                    スケジュール設定
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="export_storage" name="export_storage" checked>
                                                <label class="form-check-label" for="export_storage">
                                                    ストレージ設定
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="export_security" name="export_security">
                                                <label class="form-check-label" for="export_security">
                                                    セキュリティ設定
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="export_users" name="export_users">
                                                <label class="form-check-label" for="export_users">
                                                    ユーザー設定
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        <i class="bi bi-exclamation-triangle"></i> セキュリティ設定とユーザー設定には機密情報が含まれます
                                    </small>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label" for="export_filename">ファイル名</label>
                                    <div class="setting-description">エクスポートファイルの名前（拡張子は自動的に付与されます）</div>
                                    <input type="text" class="form-control" id="export_filename" name="export_filename"
                                           value="backup-settings-20251102" placeholder="backup-settings-YYYYMMDD" style="max-width: 500px;">
                                </div>

                                <div class="setting-item">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="executeExport()">
                                        <i class="bi bi-download"></i> エクスポート実行
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Import Settings -->
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-upload"></i> インポート設定
                            </div>
                            <div class="card-body">
                                <div class="warning-box mb-3">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>警告:</strong> インポートを実行すると現在の設定が上書きされます。事前に設定をエクスポートしてバックアップすることを強く推奨します。
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">ファイルをアップロード</label>
                                    <div class="setting-description">エクスポートしたJSON/CSVファイルをアップロードしてください</div>

                                    <!-- File Upload Area -->
                                    <div class="border border-2 border-dashed rounded p-4 text-center"
                                         id="upload-area"
                                         style="background-color: #f8f9fa; cursor: pointer;"
                                         ondrop="handleFileDrop(event)"
                                         ondragover="handleDragOver(event)"
                                         ondragleave="handleDragLeave(event)"
                                         onclick="document.getElementById('import_file').click()">
                                        <div id="upload-placeholder">
                                            <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #667eea;"></i>
                                            <p class="mb-0 mt-2"><strong>ファイルをドラッグ&ドロップ</strong></p>
                                            <p class="text-muted mb-0">または クリックしてファイルを選択</p>
                                            <small class="text-muted">対応形式: JSON, CSV (最大10MB)</small>
                                        </div>
                                        <div id="upload-selected" style="display: none;">
                                            <i class="bi bi-file-earmark-check" style="font-size: 3rem; color: #198754;"></i>
                                            <p class="mb-0 mt-2"><strong id="selected-filename"></strong></p>
                                            <p class="text-muted mb-0"><span id="selected-filesize"></span></p>
                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearFileSelection(event)">
                                                <i class="bi bi-x-circle"></i> クリア
                                            </button>
                                        </div>
                                    </div>
                                    <input type="file" id="import_file" name="import_file" accept=".json,.csv" style="display: none;" onchange="handleFileSelect(event)">
                                </div>

                                <div class="setting-item" id="format-detection" style="display: none;">
                                    <label class="setting-label">検出された形式</label>
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>形式:</strong> <span id="detected-format"></span>
                                    </div>
                                </div>

                                <div class="setting-item" id="preview-panel" style="display: none;">
                                    <label class="setting-label">プレビュー</label>
                                    <div class="setting-description">インポートされる設定内容を確認してください</div>
                                    <div class="border rounded p-3" style="background-color: #f8f9fa; max-height: 300px; overflow-y: auto;">
                                        <pre id="preview-content" style="margin: 0; font-size: 0.875rem;"></pre>
                                    </div>
                                </div>

                                <div class="setting-item" id="validation-results" style="display: none;">
                                    <label class="setting-label">検証結果</label>
                                    <div id="validation-content"></div>
                                </div>

                                <div class="setting-item" id="confirmation-section" style="display: none;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="import_confirm" name="import_confirm">
                                        <label class="form-check-label" for="import_confirm">
                                            <strong>上記の設定をインポートすることを理解しました</strong>
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item" id="import-actions" style="display: none;">
                                    <button type="button" class="btn btn-success btn-lg" id="import-execute-btn" onclick="executeImport()" disabled>
                                        <i class="bi bi-upload"></i> インポート実行
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="cancelImport()">
                                        <i class="bi bi-x-circle"></i> キャンセル
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Usage Guide -->
                        <div class="settings-card">
                            <div class="card-header">
                                <i class="bi bi-question-circle"></i> 使用ガイド
                            </div>
                            <div class="card-body">
                                <div class="accordion" id="guideAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingExport">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExport">
                                                エクスポートとは？
                                            </button>
                                        </h2>
                                        <div id="collapseExport" class="accordion-collapse collapse" data-bs-parent="#guideAccordion">
                                            <div class="accordion-body">
                                                <p><strong>エクスポート機能</strong>は、現在のシステム設定をファイルとして保存する機能です。</p>
                                                <ul>
                                                    <li>設定のバックアップとして保存できます</li>
                                                    <li>他のシステムへ設定を移行する際に使用できます</li>
                                                    <li>設定変更前の状態を保存しておくことができます</li>
                                                    <li>JSON形式とCSV形式が選択できます</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingImport">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImport">
                                                インポートとは？
                                            </button>
                                        </h2>
                                        <div id="collapseImport" class="accordion-collapse collapse" data-bs-parent="#guideAccordion">
                                            <div class="accordion-body">
                                                <p><strong>インポート機能</strong>は、エクスポートしたファイルから設定を復元する機能です。</p>
                                                <ul>
                                                    <li>以前エクスポートした設定を復元できます</li>
                                                    <li>他のシステムから設定を移行できます</li>
                                                    <li>インポート前に設定内容をプレビューできます</li>
                                                    <li>自動的に設定の妥当性が検証されます</li>
                                                </ul>
                                                <div class="alert alert-warning mt-2">
                                                    <i class="bi bi-exclamation-triangle"></i> インポートは現在の設定を上書きします。事前にエクスポートでバックアップを取ることを推奨します。
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingFormats">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFormats">
                                                JSON vs CSV の違い
                                            </button>
                                        </h2>
                                        <div id="collapseFormats" class="accordion-collapse collapse" data-bs-parent="#guideAccordion">
                                            <div class="accordion-body">
                                                <h6><i class="bi bi-filetype-json"></i> JSON形式</h6>
                                                <ul>
                                                    <li><strong>推奨:</strong> システム間での設定移行</li>
                                                    <li>階層構造を保持できる</li>
                                                    <li>完全な設定情報を含む</li>
                                                    <li>プログラムで処理しやすい</li>
                                                </ul>

                                                <h6 class="mt-3"><i class="bi bi-filetype-csv"></i> CSV形式</h6>
                                                <ul>
                                                    <li><strong>推奨:</strong> 表形式での確認・編集</li>
                                                    <li>ExcelやLibreOfficeで開ける</li>
                                                    <li>設定値の一覧表示に適している</li>
                                                    <li>複雑な階層構造には不向き</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingBackup">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBackup">
                                                バックアップ推奨
                                            </button>
                                        </h2>
                                        <div id="collapseBackup" class="accordion-collapse collapse" data-bs-parent="#guideAccordion">
                                            <div class="accordion-body">
                                                <h6>定期的なエクスポートを推奨するタイミング:</h6>
                                                <ul>
                                                    <li>重要な設定変更を行う前</li>
                                                    <li>システムアップデート前</li>
                                                    <li>月次/四半期ごとの定期バックアップ</li>
                                                    <li>新しいバックアップジョブを追加した後</li>
                                                </ul>

                                                <h6 class="mt-3">エクスポートファイルの保管場所:</h6>
                                                <ul>
                                                    <li>バックアップシステムとは別の場所に保管</li>
                                                    <li>クラウドストレージへのアップロード</li>
                                                    <li>バージョン管理システム（Git等）での管理</li>
                                                    <li>複数世代のファイルを保持</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingTroubleshooting">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTroubleshooting">
                                                トラブルシューティング
                                            </button>
                                        </h2>
                                        <div id="collapseTroubleshooting" class="accordion-collapse collapse" data-bs-parent="#guideAccordion">
                                            <div class="accordion-body">
                                                <h6>よくある問題と解決方法:</h6>

                                                <p><strong>Q: インポートファイルが認識されない</strong></p>
                                                <ul>
                                                    <li>ファイル形式が正しいか確認（.json または .csv）</li>
                                                    <li>ファイルが破損していないか確認</li>
                                                    <li>ファイルサイズが10MB以下か確認</li>
                                                </ul>

                                                <p><strong>Q: 検証エラーが表示される</strong></p>
                                                <ul>
                                                    <li>インポートファイルのバージョンが古い可能性</li>
                                                    <li>必須項目が不足している可能性</li>
                                                    <li>設定値の形式が不正な可能性</li>
                                                </ul>

                                                <p><strong>Q: インポート後に問題が発生した</strong></p>
                                                <ul>
                                                    <li>エクスポートしたバックアップファイルを使用して元に戻す</li>
                                                    <li>「デフォルトに戻す」機能を使用する</li>
                                                    <li>問題のある設定項目を個別に修正する</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="settings-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> 最終更新: 2025-11-02 14:30:00
                                </small>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                    <i class="bi bi-arrow-counterclockwise"></i> リセット
                                </button>
                                <button type="submit" class="btn btn-primary btn-save">
                                    <i class="bi bi-check-circle"></i> 設定を保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="bi bi-person-plus"></i> 新規ユーザー追加
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_username" class="form-label">ユーザー名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="add_username" name="username" required>
                            <div class="invalid-feedback">ユーザー名は必須です（3-50文字、英数字とアンダースコアのみ）</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_email" class="form-label">メールアドレス <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="add_email" name="email" required>
                            <div class="invalid-feedback">有効なメールアドレスを入力してください</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_full_name" class="form-label">氏名</label>
                            <input type="text" class="form-control" id="add_full_name" name="full_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_department" class="form-label">部署</label>
                            <input type="text" class="form-control" id="add_department" name="department">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="add_role" class="form-label">権限 <span class="text-danger">*</span></label>
                        <select class="form-select" id="add_role" name="role" required>
                            <option value="">選択してください</option>
                            <option value="admin">管理者 - すべての機能にアクセス可能</option>
                            <option value="operator">オペレーター - バックアップの実行と管理</option>
                            <option value="viewer">閲覧者 - 読み取り専用アクセス</option>
                            <option value="auditor">監査者 - ログとレポートの閲覧</option>
                        </select>
                        <div class="invalid-feedback">権限を選択してください</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_password" class="form-label">パスワード <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="add_password" name="password" required>
                            <div class="password-strength-meter">
                                <div class="password-strength-bar" id="add_password_strength"></div>
                            </div>
                            <small class="text-muted d-block mt-1" id="add_password_hint">
                                最低8文字、大文字・小文字・数字・特殊文字を含む
                            </small>
                            <div class="invalid-feedback">パスワード要件を満たしていません</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_confirm_password" class="form-label">パスワード確認 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="add_confirm_password" name="confirm_password" required>
                            <div class="invalid-feedback">パスワードが一致しません</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="add_is_active" name="is_active" checked>
                            <label class="form-check-label" for="add_is_active">
                                アクティブ（ログイン可能）
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> キャンセル
                </button>
                <button type="button" class="btn btn-primary" onclick="createUser()">
                    <i class="bi bi-check-circle"></i> 作成
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">
                    <i class="bi bi-person-gear"></i> ユーザー編集
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="edit_user_id" name="user_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_username" class="form-label">ユーザー名</label>
                            <input type="text" class="form-control" id="edit_username" name="username" readonly>
                            <small class="text-muted">ユーザー名は変更できません</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_email" class="form-label">メールアドレス <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="edit_email" name="email" required>
                            <div class="invalid-feedback">有効なメールアドレスを入力してください</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_full_name" class="form-label">氏名</label>
                            <input type="text" class="form-control" id="edit_full_name" name="full_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_department" class="form-label">部署</label>
                            <input type="text" class="form-control" id="edit_department" name="department">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_role" class="form-label">権限 <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit_role" name="role" required>
                            <option value="admin">管理者 - すべての機能にアクセス可能</option>
                            <option value="operator">オペレーター - バックアップの実行と管理</option>
                            <option value="viewer">閲覧者 - 読み取り専用アクセス</option>
                            <option value="auditor">監査者 - ログとレポートの閲覧</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit_change_password" name="change_password">
                            <label class="form-check-label fw-bold" for="edit_change_password">
                                パスワードを変更する
                            </label>
                        </div>
                    </div>
                    <div id="edit_password_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_password" class="form-label">新しいパスワード</label>
                                <input type="password" class="form-control" id="edit_password" name="password">
                                <div class="password-strength-meter">
                                    <div class="password-strength-bar" id="edit_password_strength"></div>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    最低8文字、大文字・小文字・数字・特殊文字を含む
                                </small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_confirm_password" class="form-label">パスワード確認</label>
                                <input type="password" class="form-control" id="edit_confirm_password" name="confirm_password">
                                <div class="invalid-feedback">パスワードが一致しません</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                            <label class="form-check-label" for="edit_is_active">
                                アクティブ（ログイン可能）
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> キャンセル
                </button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">
                    <i class="bi bi-check-circle"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white" id="deleteUserModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> ユーザー削除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="danger-box mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>警告:</strong> この操作は取り消せません！
                </div>
                <p>以下のユーザーを削除しようとしています:</p>
                <div class="card bg-light">
                    <div class="card-body">
                        <p class="mb-1"><strong>ユーザー名:</strong> <span id="delete_username"></span></p>
                        <p class="mb-1"><strong>メール:</strong> <span id="delete_email"></span></p>
                        <p class="mb-0"><strong>氏名:</strong> <span id="delete_full_name"></span></p>
                    </div>
                </div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="delete_confirm" required>
                    <label class="form-check-label fw-bold text-danger" for="delete_confirm">
                        このユーザーを削除することを理解しました
                    </label>
                </div>
                <input type="hidden" id="delete_user_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> キャンセル
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()" id="deleteUserBtn" disabled>
                    <i class="bi bi-trash"></i> 削除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">
                    <i class="bi bi-key"></i> パスワードリセット
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ユーザー <strong id="reset_username"></strong> のパスワードをリセットします。</p>
                <p>一時パスワードがメールで送信されます。</p>
                <input type="hidden" id="reset_user_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> キャンセル
                </button>
                <button type="button" class="btn btn-warning" onclick="confirmResetPassword()">
                    <i class="bi bi-key"></i> リセット
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Enable/disable encryption options
    document.getElementById('enable_encryption').addEventListener('change', function() {
        document.getElementById('encryption-options').style.display = this.checked ? 'block' : 'none';
    });

    // Enable/disable email settings
    document.getElementById('enable_email').addEventListener('change', function() {
        document.getElementById('email-settings').style.display = this.checked ? 'block' : 'none';
    });

    // Enable/disable Slack settings
    document.getElementById('enable_slack').addEventListener('change', function() {
        document.getElementById('slack-settings').style.display = this.checked ? 'block' : 'none';
    });

    // Enable/disable Teams settings
    document.getElementById('enable_teams').addEventListener('change', function() {
        document.getElementById('teams-settings').style.display = this.checked ? 'block' : 'none';
    });

    // Generate encryption key
    function generateKey() {
        const key = Array.from(crypto.getRandomValues(new Uint8Array(32)))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');
        document.getElementById('encryption_key').value = key;
    }

    // Export settings
    function exportSettings() {
        if (confirm('現在の設定をJSONファイルとしてエクスポートしますか?')) {
            window.location.href = '/settings/export';
        }
    }

    // Import settings
    function importSettings() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const settings = JSON.parse(event.target.result);
                        if (confirm('設定をインポートしますか? 現在の設定は上書きされます。')) {
                            // Send to server
                            fetch('/settings/import', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(settings)
                            }).then(response => {
                                if (response.ok) {
                                    alert('設定をインポートしました');
                                    location.reload();
                                } else {
                                    alert('インポートに失敗しました');
                                }
                            });
                        }
                    } catch (error) {
                        alert('無効な設定ファイルです');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }

    // Reset to defaults
    function resetToDefaults() {
        if (confirm('すべての設定をデフォルト値に戻しますか? この操作は取り消せません。')) {
            fetch('/settings/reset', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    alert('設定をリセットしました');
                    location.reload();
                } else {
                    alert('リセットに失敗しました');
                }
            });
        }
    }

    // Browse folder
    function browseFolder() {
        alert('フォルダブラウザは開発中です。パスを直接入力してください。');
    }

    // Optimize database
    function optimizeDatabase() {
        if (confirm('データベースを最適化しますか? この操作には数分かかる場合があります。')) {
            fetch('/settings/optimize-db', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    alert('データベースの最適化が完了しました');
                } else {
                    alert('最適化に失敗しました');
                }
            });
        }
    }

    // Clear cache
    function clearCache() {
        if (confirm('キャッシュをクリアしますか?')) {
            fetch('/settings/clear-cache', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    alert('キャッシュをクリアしました');
                } else {
                    alert('クリアに失敗しました');
                }
            });
        }
    }

    // Rotate logs
    function rotateLogs() {
        if (confirm('ログローテーションを実行しますか?')) {
            fetch('/settings/rotate-logs', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    alert('ログローテーションが完了しました');
                } else {
                    alert('実行に失敗しました');
                }
            });
        }
    }

    // Test connections
    function testConnections() {
        alert('接続テストを開始します...');
        fetch('/settings/test-connections', {
            method: 'POST'
        }).then(response => response.json())
        .then(data => {
            let message = '接続テスト結果:\n\n';
            message += `データベース: ${data.database ? '✓ 成功' : '✗ 失敗'}\n`;
            message += `メール: ${data.email ? '✓ 成功' : '✗ 失敗'}\n`;
            message += `ストレージ: ${data.storage ? '✓ 成功' : '✗ 失敗'}`;
            alert(message);
        });
    }

    // Reset form
    function resetForm() {
        if (confirm('フォームをリセットしますか? 未保存の変更は失われます。')) {
            document.getElementById('settings-form').reset();
        }
    }

    // Form validation
    document.getElementById('settings-form').addEventListener('submit', function(e) {
        e.preventDefault();

        if (confirm('設定を保存しますか?')) {
            // Show loading
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';
            btn.disabled = true;

            // Submit form
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    alert('設定を保存しました');
                    location.reload();
                } else {
                    alert('保存に失敗しました');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }).catch(error => {
                alert('エラーが発生しました: ' + error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    });

    // User Management Functions
    let usersTable;

    // Initialize DataTable
    $(document).ready(function() {
        if ($('#usersTable').length) {
            usersTable = $('#usersTable').DataTable({
                ajax: {
                    url: '/settings/users',
                    dataSrc: 'users'
                },
                columns: [
                    { data: 'username' },
                    { data: 'email' },
                    { data: 'full_name' },
                    { data: 'department' },
                    {
                        data: 'role',
                        render: function(data) {
                            const roleClasses = {
                                'admin': 'role-admin',
                                'operator': 'role-operator',
                                'viewer': 'role-viewer',
                                'auditor': 'role-auditor'
                            };
                            const roleNames = {
                                'admin': '管理者',
                                'operator': 'オペレーター',
                                'viewer': '閲覧者',
                                'auditor': '監査者'
                            };
                            return `<span class="badge badge-role ${roleClasses[data]}">${roleNames[data]}</span>`;
                        }
                    },
                    {
                        data: 'is_active',
                        render: function(data, type, row) {
                            if (data) {
                                return '<span class="status-active"><i class="bi bi-check-circle"></i> アクティブ</span>';
                            } else {
                                return '<span class="status-inactive"><i class="bi bi-x-circle"></i> 無効</span>';
                            }
                        }
                    },
                    {
                        data: 'last_login',
                        render: function(data) {
                            return data ? new Date(data).toLocaleString('ja-JP') : '-';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            let actions = `
                                <button class="btn btn-sm btn-outline-primary btn-action" onclick="showEditUserModal(${row.id})" title="編集">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            `;

                            if (row.is_active) {
                                actions += `
                                    <button class="btn btn-sm btn-outline-warning btn-action" onclick="toggleUserStatus(${row.id}, false)" title="無効化">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                `;
                            } else {
                                actions += `
                                    <button class="btn btn-sm btn-outline-success btn-action" onclick="toggleUserStatus(${row.id}, true)" title="有効化">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                `;
                            }

                            if (row.account_locked_until && new Date(row.account_locked_until) > new Date()) {
                                actions += `
                                    <button class="btn btn-sm btn-outline-info btn-action" onclick="unlockUser(${row.id})" title="ロック解除">
                                        <i class="bi bi-unlock"></i>
                                    </button>
                                `;
                            }

                            actions += `
                                <button class="btn btn-sm btn-outline-warning btn-action" onclick="showResetPasswordModal(${row.id}, '${row.username}')" title="パスワードリセット">
                                    <i class="bi bi-key"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-action" onclick="showDeleteUserModal(${row.id}, '${row.username}', '${row.email}', '${row.full_name || ''}')" title="削除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            `;

                            return actions;
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json'
                },
                order: [[0, 'asc']],
                pageLength: 25,
                drawCallback: function() {
                    updateUserStatistics();
                }
            });
        }
    });

    // Update user statistics
    function updateUserStatistics() {
        fetch('/settings/users')
            .then(response => response.json())
            .then(data => {
                const users = data.users;
                $('#totalUsers').text(users.length);
                $('#activeUsers').text(users.filter(u => u.is_active).length);
                $('#adminUsers').text(users.filter(u => u.role === 'admin').length);
                $('#operatorUsers').text(users.filter(u => u.role === 'operator').length);
                $('#lockedUsers').text(users.filter(u => u.account_locked_until && new Date(u.account_locked_until) > new Date()).length);
                // Online users would require session tracking
                $('#onlineUsers').text('N/A');
            });
    }

    // Show add user modal
    function showAddUserModal() {
        $('#addUserForm')[0].reset();
        $('#add_password_strength').removeClass().addClass('password-strength-bar');
        $('.is-invalid').removeClass('is-invalid');
        new bootstrap.Modal(document.getElementById('addUserModal')).show();
    }

    // Password strength checker
    function checkPasswordStrength(password, strengthElementId) {
        const strengthBar = document.getElementById(strengthElementId);
        let strength = 0;

        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        strengthBar.className = 'password-strength-bar';
        if (strength < 3) {
            strengthBar.classList.add('password-strength-weak');
        } else if (strength < 5) {
            strengthBar.classList.add('password-strength-medium');
        } else {
            strengthBar.classList.add('password-strength-strong');
        }

        return strength >= 4;
    }

    // Add password strength listeners
    $('#add_password').on('input', function() {
        checkPasswordStrength($(this).val(), 'add_password_strength');
    });

    $('#edit_password').on('input', function() {
        checkPasswordStrength($(this).val(), 'edit_password_strength');
    });

    // Toggle password section in edit modal
    $('#edit_change_password').on('change', function() {
        $('#edit_password_section').toggle(this.checked);
        if (!this.checked) {
            $('#edit_password').val('');
            $('#edit_confirm_password').val('');
        }
    });

    // Enable delete button when checkbox is checked
    $('#delete_confirm').on('change', function() {
        $('#deleteUserBtn').prop('disabled', !this.checked);
    });

    // Validate username
    function validateUsername(username) {
        const regex = /^[a-zA-Z0-9_]{3,50}$/;
        return regex.test(username);
    }

    // Validate email
    function validateEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    // Validate password
    function validatePassword(password) {
        return password.length >= 8 &&
               /[a-z]/.test(password) &&
               /[A-Z]/.test(password) &&
               /[0-9]/.test(password) &&
               /[^a-zA-Z0-9]/.test(password);
    }

    // Create user
    function createUser() {
        const form = document.getElementById('addUserForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Validation
        let isValid = true;
        $('.is-invalid').removeClass('is-invalid');

        if (!validateUsername(data.username)) {
            $('#add_username').addClass('is-invalid');
            isValid = false;
        }

        if (!validateEmail(data.email)) {
            $('#add_email').addClass('is-invalid');
            isValid = false;
        }

        if (!data.role) {
            $('#add_role').addClass('is-invalid');
            isValid = false;
        }

        if (!validatePassword(data.password)) {
            $('#add_password').addClass('is-invalid');
            isValid = false;
        }

        if (data.password !== data.confirm_password) {
            $('#add_confirm_password').addClass('is-invalid');
            isValid = false;
        }

        if (!isValid) {
            return;
        }

        // Convert checkbox value
        data.is_active = $('#add_is_active').is(':checked');

        // Send request
        fetch('/settings/users/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('エラー: ' + result.error.message);
            } else {
                alert('ユーザーを作成しました');
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                usersTable.ajax.reload();
            }
        })
        .catch(error => {
            alert('エラーが発生しました: ' + error);
        });
    }

    // Show edit user modal
    function showEditUserModal(userId) {
        fetch('/settings/users')
            .then(response => response.json())
            .then(data => {
                const user = data.users.find(u => u.id === userId);
                if (user) {
                    $('#edit_user_id').val(user.id);
                    $('#edit_username').val(user.username);
                    $('#edit_email').val(user.email);
                    $('#edit_full_name').val(user.full_name || '');
                    $('#edit_department').val(user.department || '');
                    $('#edit_role').val(user.role);
                    $('#edit_is_active').prop('checked', user.is_active);
                    $('#edit_change_password').prop('checked', false);
                    $('#edit_password_section').hide();
                    $('#edit_password').val('');
                    $('#edit_confirm_password').val('');
                    $('.is-invalid').removeClass('is-invalid');

                    new bootstrap.Modal(document.getElementById('editUserModal')).show();
                }
            });
    }

    // Update user
    function updateUser() {
        const userId = $('#edit_user_id').val();
        const data = {
            email: $('#edit_email').val(),
            full_name: $('#edit_full_name').val(),
            department: $('#edit_department').val(),
            role: $('#edit_role').val(),
            is_active: $('#edit_is_active').is(':checked')
        };

        // Validation
        let isValid = true;
        $('.is-invalid').removeClass('is-invalid');

        if (!validateEmail(data.email)) {
            $('#edit_email').addClass('is-invalid');
            isValid = false;
        }

        // If changing password
        if ($('#edit_change_password').is(':checked')) {
            const password = $('#edit_password').val();
            const confirmPassword = $('#edit_confirm_password').val();

            if (!validatePassword(password)) {
                $('#edit_password').addClass('is-invalid');
                isValid = false;
            }

            if (password !== confirmPassword) {
                $('#edit_confirm_password').addClass('is-invalid');
                isValid = false;
            }

            if (isValid) {
                data.password = password;
            }
        }

        if (!isValid) {
            return;
        }

        // Send request
        fetch(`/settings/users/${userId}/update`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('エラー: ' + result.error.message);
            } else {
                alert('ユーザー情報を更新しました');
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                usersTable.ajax.reload();
            }
        })
        .catch(error => {
            alert('エラーが発生しました: ' + error);
        });
    }

    // Show delete user modal
    function showDeleteUserModal(userId, username, email, fullName) {
        $('#delete_user_id').val(userId);
        $('#delete_username').text(username);
        $('#delete_email').text(email);
        $('#delete_full_name').text(fullName || '-');
        $('#delete_confirm').prop('checked', false);
        $('#deleteUserBtn').prop('disabled', true);

        new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
    }

    // Confirm delete user
    function confirmDeleteUser() {
        const userId = $('#delete_user_id').val();

        fetch(`/settings/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('エラー: ' + result.error.message);
            } else {
                alert('ユーザーを削除しました');
                bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
                usersTable.ajax.reload();
            }
        })
        .catch(error => {
            alert('エラーが発生しました: ' + error);
        });
    }

    // Toggle user status
    function toggleUserStatus(userId, activate) {
        const action = activate ? '有効化' : '無効化';

        if (confirm(`このユーザーを${action}しますか?`)) {
            fetch(`/settings/users/${userId}/toggle-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_active: activate })
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('エラー: ' + result.error.message);
                } else {
                    alert(`ユーザーを${action}しました`);
                    usersTable.ajax.reload();
                }
            })
            .catch(error => {
                alert('エラーが発生しました: ' + error);
            });
        }
    }

    // Unlock user
    function unlockUser(userId) {
        if (confirm('このユーザーのロックを解除しますか?')) {
            fetch(`/settings/users/${userId}/unlock`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('エラー: ' + result.error.message);
                } else {
                    alert('ユーザーのロックを解除しました');
                    usersTable.ajax.reload();
                }
            })
            .catch(error => {
                alert('エラーが発生しました: ' + error);
            });
        }
    }

    // Show reset password modal
    function showResetPasswordModal(userId, username) {
        $('#reset_user_id').val(userId);
        $('#reset_username').text(username);

        new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
    }

    // Confirm reset password
    function confirmResetPassword() {
        const userId = $('#reset_user_id').val();

        fetch(`/settings/users/${userId}/reset-password`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('エラー: ' + result.error.message);
            } else {
                alert('パスワードをリセットしました。一時パスワードをメールで送信しました。');
                bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
            }
        })
        .catch(error => {
            alert('エラーが発生しました: ' + error);
        });
    }

    // ========================================
    // Import/Export Functions
    // ========================================

    let uploadedFile = null;
    let validatedData = null;

    function executeExport() {
        const format = document.querySelector('input[name="export_format"]:checked').value;
        const sections = {
            backup: document.getElementById('export_backup').checked,
            notification: document.getElementById('export_notification').checked,
            schedule: document.getElementById('export_schedule').checked,
            storage: document.getElementById('export_storage').checked,
            security: document.getElementById('export_security').checked,
            users: document.getElementById('export_users').checked
        };
        const filename = document.getElementById('export_filename').value || 'backup-settings';
        const params = new URLSearchParams({format: format, filename: filename, ...sections});
        window.location.href = '/settings/export?' + params.toString();
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) processFile(file);
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('upload-area').style.borderColor = '#667eea';
        document.getElementById('upload-area').style.backgroundColor = '#e0f2fe';
    }

    function handleDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('upload-area').style.borderColor = '#dee2e6';
        document.getElementById('upload-area').style.backgroundColor = '#f8f9fa';
    }

    function handleFileDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('upload-area').style.borderColor = '#dee2e6';
        document.getElementById('upload-area').style.backgroundColor = '#f8f9fa';
        const file = event.dataTransfer.files[0];
        if (file) processFile(file);
    }

    function processFile(file) {
        if (file.size > 10 * 1024 * 1024) {
            alert('ファイルサイズが大きすぎます（最大10MB）');
            return;
        }
        const extension = file.name.split('.').pop().toLowerCase();
        if (!['json', 'csv'].includes(extension)) {
            alert('対応していないファイル形式です（JSON/CSVのみ）');
            return;
        }
        uploadedFile = file;
        document.getElementById('upload-placeholder').style.display = 'none';
        document.getElementById('upload-selected').style.display = 'block';
        document.getElementById('selected-filename').textContent = file.name;
        document.getElementById('selected-filesize').textContent = formatFileSize(file.size);
        document.getElementById('format-detection').style.display = 'block';
        document.getElementById('detected-format').textContent = extension.toUpperCase();
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                let data = extension === 'json' ? JSON.parse(content) : parseCSV(content);
                document.getElementById('preview-panel').style.display = 'block';
                document.getElementById('preview-content').textContent = JSON.stringify(data, null, 2);
                validateSettings(data);
            } catch (error) {
                alert('ファイルの読み込みに失敗しました: ' + error.message);
                clearFileSelection();
            }
        };
        reader.readAsText(file);
    }

    function validateSettings(data) {
        const formData = new FormData();
        formData.append('file', uploadedFile);
        fetch('/settings/validate-import', {method: 'POST', body: formData})
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                showValidationResults(false, result.error.message, result.errors || []);
            } else {
                validatedData = result.data;
                showValidationResults(true, result.message, result.warnings || []);
            }
        })
        .catch(error => {
            showValidationResults(false, 'サーバーエラー: ' + error.message);
        });
    }

    function showValidationResults(isValid, message, issues = []) {
        const validationContent = document.getElementById('validation-content');
        document.getElementById('validation-results').style.display = 'block';
        if (isValid) {
            let html = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> <strong>検証成功:</strong> ' + message + '</div>';
            if (issues.length > 0) {
                html += '<div class="alert alert-warning mt-2"><i class="bi bi-exclamation-triangle"></i> <strong>警告:</strong><ul class="mb-0 mt-2">';
                issues.forEach(issue => { html += '<li>' + issue + '</li>'; });
                html += '</ul></div>';
            }
            validationContent.innerHTML = html;
            document.getElementById('confirmation-section').style.display = 'block';
            document.getElementById('import-actions').style.display = 'block';
            document.getElementById('import_confirm').addEventListener('change', function() {
                document.getElementById('import-execute-btn').disabled = !this.checked;
            });
        } else {
            let html = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> <strong>検証失敗:</strong> ' + message + '</div>';
            if (issues.length > 0) {
                html += '<div class="alert alert-danger mt-2"><strong>エラー詳細:</strong><ul class="mb-0 mt-2">';
                issues.forEach(issue => { html += '<li>' + issue + '</li>'; });
                html += '</ul></div>';
            }
            validationContent.innerHTML = html;
            document.getElementById('confirmation-section').style.display = 'none';
            document.getElementById('import-actions').style.display = 'none';
        }
    }

    function executeImport() {
        if (!validatedData) { alert('データが検証されていません'); return; }
        if (!document.getElementById('import_confirm').checked) { alert('確認チェックボックスをチェックしてください'); return; }
        if (!confirm('本当にインポートを実行しますか？現在の設定が上書きされます。')) return;
        document.getElementById('import-execute-btn').disabled = true;
        document.getElementById('import-execute-btn').innerHTML = '<i class="bi bi-hourglass-split"></i> インポート中...';
        const formData = new FormData();
        formData.append('file', uploadedFile);
        formData.append('confirmed', 'true');
        fetch('/settings/import', {method: 'POST', body: formData})
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('インポートエラー: ' + result.error.message);
                document.getElementById('import-execute-btn').innerHTML = '<i class="bi bi-upload"></i> インポート実行';
                document.getElementById('import-execute-btn').disabled = false;
            } else {
                alert('設定をインポートしました。ページを再読み込みします。');
                location.reload();
            }
        })
        .catch(error => {
            alert('エラーが発生しました: ' + error.message);
            document.getElementById('import-execute-btn').innerHTML = '<i class="bi bi-upload"></i> インポート実行';
            document.getElementById('import-execute-btn').disabled = false;
        });
    }

    function cancelImport() {
        clearFileSelection();
    }

    function clearFileSelection(event) {
        if (event) event.stopPropagation();
        uploadedFile = null;
        validatedData = null;
        document.getElementById('import_file').value = '';
        document.getElementById('upload-placeholder').style.display = 'block';
        document.getElementById('upload-selected').style.display = 'none';
        document.getElementById('format-detection').style.display = 'none';
        document.getElementById('preview-panel').style.display = 'none';
        document.getElementById('validation-results').style.display = 'none';
        document.getElementById('confirmation-section').style.display = 'none';
        document.getElementById('import-actions').style.display = 'none';
        document.getElementById('import_confirm').checked = false;
    }

    function parseCSV(content) {
        const lines = content.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const data = {};
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            const section = values[0];
            const key = values[1];
            const value = values[2];
            if (!data[section]) data[section] = {};
            data[section][key] = value;
        }
        return data;
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

</script>
{% endblock %}
