{% extends "base.html" %}

{% block title %}バックアップスケジュール管理 - バックアップ管理システム{% endblock %}

{% block extra_css %}
<style>
    .cron-builder {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .cron-preview {
        background: #e9ecef;
        border-left: 4px solid #0d6efd;
        padding: 15px;
        margin-top: 15px;
        font-family: 'Courier New', monospace;
    }

    .schedule-calendar {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .priority-badge {
        font-size: 0.9rem;
        padding: 6px 12px;
    }

    .time-picker-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .cron-segment {
        flex: 1;
        min-width: 80px;
    }

    .schedule-preview-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .next-run-time {
        font-weight: bold;
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-calendar-check"></i> バックアップスケジュール管理</h1>
            <p class="text-muted">バックアップジョブのスケジュール設定と管理</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newScheduleModal">
                <i class="bi bi-plus-circle"></i> 新規スケジュール作成
            </button>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Active Schedules -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> アクティブなスケジュール</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="scheduleTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ジョブ名</th>
                            <th>スケジュール</th>
                            <th>次回実行</th>
                            <th>優先度</th>
                            <th>ステータス</th>
                            <th>最終実行</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for schedule in schedules %}
                        <tr data-schedule-id="{{ schedule.id }}">
                            <td>
                                <strong>{{ schedule.job_name }}</strong>
                                <br>
                                <small class="text-muted">{{ schedule.source_path }}</small>
                            </td>
                            <td>
                                <code>{{ schedule.cron_expression }}</code>
                                <br>
                                <small class="text-muted">{{ schedule.schedule_description }}</small>
                            </td>
                            <td>
                                <span class="next-run-time">{{ schedule.next_run.strftime('%Y-%m-%d %H:%M') if schedule.next_run else 'N/A' }}</span>
                            </td>
                            <td>
                                {% if schedule.priority == 'high' %}
                                    <span class="badge priority-badge bg-danger">高</span>
                                {% elif schedule.priority == 'medium' %}
                                    <span class="badge priority-badge bg-warning text-dark">中</span>
                                {% else %}
                                    <span class="badge priority-badge bg-info text-dark">低</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if schedule.is_active %}
                                    <span class="badge bg-success">有効</span>
                                {% else %}
                                    <span class="badge bg-secondary">無効</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if schedule.last_run %}
                                    {{ schedule.last_run.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    <span class="text-muted">未実行</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-schedule"
                                            data-schedule-id="{{ schedule.id }}"
                                            title="編集">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info test-schedule"
                                            data-schedule-id="{{ schedule.id }}"
                                            title="テスト実行">
                                        <i class="bi bi-play-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-warning toggle-schedule"
                                            data-schedule-id="{{ schedule.id }}"
                                            data-active="{{ schedule.is_active }}"
                                            title="{% if schedule.is_active %}無効化{% else %}有効化{% endif %}">
                                        <i class="bi bi-{% if schedule.is_active %}pause{% else %}play{% endif %}-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-schedule"
                                            data-schedule-id="{{ schedule.id }}"
                                            title="削除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Schedule Statistics -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ stats.total_schedules }}</h3>
                    <p class="text-muted mb-0">総スケジュール数</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ stats.active_schedules }}</h3>
                    <p class="text-muted mb-0">アクティブ</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ stats.next_24h }}</h3>
                    <p class="text-muted mb-0">24時間以内実行</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ stats.high_priority }}</h3>
                    <p class="text-muted mb-0">高優先度</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Schedule Modal -->
<div class="modal fade" id="newScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新規スケジュール作成</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <div class="row">
                        <!-- Left Column: Basic Info -->
                        <div class="col-md-6">
                            <h6 class="mb-3">基本設定</h6>

                            <div class="mb-3">
                                <label class="form-label">バックアップジョブ <span class="text-danger">*</span></label>
                                <select class="form-select" id="jobSelect" name="job_id" required>
                                    <option value="">選択してください</option>
                                    {% for job in jobs %}
                                    <option value="{{ job.id }}">{{ job.job_name }} - {{ job.source_path }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">優先度 <span class="text-danger">*</span></label>
                                <select class="form-select" id="priority" name="priority" required>
                                    <option value="low">低 - 通常のバックアップ</option>
                                    <option value="medium" selected>中 - 重要なデータ</option>
                                    <option value="high">高 - クリティカルなデータ</option>
                                </select>
                                <small class="form-text text-muted">優先度が高いジョブは他のジョブより優先的に実行されます</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">説明</label>
                                <textarea class="form-control" id="description" name="description" rows="3"
                                          placeholder="スケジュールの説明を入力"></textarea>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                                    <label class="form-check-label" for="isActive">
                                        スケジュールを有効化
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Schedule Settings -->
                        <div class="col-md-6">
                            <h6 class="mb-3">スケジュール設定</h6>

                            <div class="cron-builder">
                                <div class="mb-3">
                                    <label class="form-label">スケジュールタイプ</label>
                                    <select class="form-select" id="scheduleType">
                                        <option value="preset">プリセット</option>
                                        <option value="custom">カスタムCron式</option>
                                        <option value="builder">ビルダー</option>
                                    </select>
                                </div>

                                <!-- Preset Options -->
                                <div id="presetOptions" class="schedule-option">
                                    <label class="form-label">プリセットスケジュール</label>
                                    <select class="form-select" id="presetSchedule">
                                        <option value="0 2 * * *">毎日 2:00 AM</option>
                                        <option value="0 3 * * 0">毎週日曜 3:00 AM</option>
                                        <option value="0 4 1 * *">毎月1日 4:00 AM</option>
                                        <option value="*/30 * * * *">30分ごと</option>
                                        <option value="0 */6 * * *">6時間ごと</option>
                                        <option value="0 2 * * 1-5">平日 2:00 AM</option>
                                    </select>
                                </div>

                                <!-- Custom Cron Expression -->
                                <div id="customOptions" class="schedule-option" style="display: none;">
                                    <label class="form-label">Cron式 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control font-monospace" id="cronExpression"
                                           name="cron_expression" placeholder="0 2 * * *">
                                    <small class="form-text text-muted">形式: 分 時 日 月 曜日</small>
                                </div>

                                <!-- Cron Builder -->
                                <div id="builderOptions" class="schedule-option" style="display: none;">
                                    <div class="time-picker-group mb-2">
                                        <div class="cron-segment">
                                            <label class="form-label">分</label>
                                            <input type="number" class="form-control" id="cronMinute" min="0" max="59" value="0">
                                        </div>
                                        <div class="cron-segment">
                                            <label class="form-label">時</label>
                                            <input type="number" class="form-control" id="cronHour" min="0" max="23" value="2">
                                        </div>
                                        <div class="cron-segment">
                                            <label class="form-label">日</label>
                                            <input type="text" class="form-control" id="cronDay" placeholder="*" value="*">
                                        </div>
                                        <div class="cron-segment">
                                            <label class="form-label">月</label>
                                            <input type="text" class="form-control" id="cronMonth" placeholder="*" value="*">
                                        </div>
                                        <div class="cron-segment">
                                            <label class="form-label">曜日</label>
                                            <input type="text" class="form-control" id="cronDayOfWeek" placeholder="*" value="*">
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        * = すべて、1-5 = 範囲、*/2 = 間隔、1,3,5 = 複数指定
                                    </small>
                                </div>

                                <!-- Preview -->
                                <div class="cron-preview">
                                    <strong>プレビュー:</strong>
                                    <div id="cronPreviewExpression" class="mt-2">0 2 * * *</div>
                                    <div id="cronPreviewDescription" class="mt-2 text-muted">
                                        毎日 2:00 AM に実行
                                    </div>
                                </div>

                                <button type="button" class="btn btn-sm btn-outline-primary mt-3" id="testCronBtn">
                                    <i class="bi bi-calendar3"></i> 次回実行日時を確認
                                </button>
                            </div>

                            <!-- Next Run Preview -->
                            <div id="nextRunPreview" class="mt-3" style="display: none;">
                                <div class="schedule-calendar">
                                    <h6>次回実行予定 (10回分)</h6>
                                    <div class="schedule-preview-list">
                                        <ul id="nextRunList" class="list-unstyled"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="saveScheduleBtn">
                    <i class="bi bi-save"></i> スケジュールを保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal (similar structure, populated dynamically) -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Custom Schedule Management JS -->
<script src="{{ url_for('static', filename='js/backup_schedule.js') }}"></script>

<script>
    // Initialize DataTable
    $(document).ready(function() {
        $('#scheduleTable').DataTable({
            order: [[2, 'asc']], // Sort by next run time
            pageLength: 25,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json'
            }
        });
    });
</script>
{% endblock %}
