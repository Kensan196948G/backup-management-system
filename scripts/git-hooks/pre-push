#!/bin/bash
# pre-push: ãƒ—ãƒƒã‚·ãƒ¥å‰ãƒ†ã‚¹ãƒˆ
# 3-2-1-1-0 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

set -e

echo "ğŸ§ª Running tests before push..."

# pytest ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
if ! command -v pytest &> /dev/null; then
    echo "âš ï¸  pytest not installed, skipping tests"
    exit 0
fi

# ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
if [ ! -d "tests" ]; then
    echo "â„¹ï¸  No tests directory found, skipping tests"
    exit 0
fi

# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
if [ -z "$(ls -A tests/unit/ 2>/dev/null)" ] && [ -z "$(ls -A tests/integration/ 2>/dev/null)" ]; then
    echo "â„¹ï¸  No test files found, skipping test execution"
    exit 0
fi

# å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
echo "ğŸ”¬ Running unit tests..."
pytest tests/unit/ -v --tb=short 2>/dev/null || {
    echo "âŒ Unit tests failed! Push aborted."
    echo "ğŸ’¡ Fix the tests before pushing, or use 'git push --no-verify' to skip (not recommended)"
    exit 1
}

echo ""
echo "âœ… All tests passed!"
exit 0
