#!/bin/bash
# pre-push: プッシュ前テスト
# 3-2-1-1-0 バックアップ管理システム

set -e

echo "🧪 Running tests before push..."

# pytest がインストールされているか確認
if ! command -v pytest &> /dev/null; then
    echo "⚠️  pytest not installed, skipping tests"
    exit 0
fi

# テストディレクトリが存在するか確認
if [ ! -d "tests" ]; then
    echo "ℹ️  No tests directory found, skipping tests"
    exit 0
fi

# テストファイルが存在するか確認
if [ -z "$(ls -A tests/unit/ 2>/dev/null)" ] && [ -z "$(ls -A tests/integration/ 2>/dev/null)" ]; then
    echo "ℹ️  No test files found, skipping test execution"
    exit 0
fi

# 単体テスト実行
echo "🔬 Running unit tests..."
pytest tests/unit/ -v --tb=short 2>/dev/null || {
    echo "❌ Unit tests failed! Push aborted."
    echo "💡 Fix the tests before pushing, or use 'git push --no-verify' to skip (not recommended)"
    exit 1
}

echo ""
echo "✅ All tests passed!"
exit 0
